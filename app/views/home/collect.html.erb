<br>
<div class="container-fluid">
  <div class="row">

    <div class="col-sm-3">
      <div class="well">
        <div class="row">
          <button class="btn btn-success btn-sm" onclick="starter(); " style="margin-left: 10px">开始</button>
        </div>
      </div>
      <div id="r-result"></div>
    </div>

    <div class="col-sm-9">


      <div id="l-map" style="height: 500px;width: 100%">

      </div>
    </div>

  </div>
</div>

<script type="text/javascript">


  var map = new BMap.Map("l-map");
  map.centerAndZoom(new BMap.Point(116.404, 39.915), 12);
  map.enableScrollWheelZoom(true);
  var myGeo = new BMap.Geocoder();
  var adds;
  //  var markers =[] ;
  var house_location;
  var bus_info = [];
  var subway_info = [];
  var hospital_info = [];
  var school_info = [];
  var shopping_info = [];
  var supermarket_info = [];
  var work_info = [];


  function getData() {
    $.ajax({
      type: "GET",
      url: "/ajax",
      dataType: 'json',
      success: function (data) {
//        $.each(data, function (index, element) {
        adds = data.community;
//        });
      },
      error: function () {
        alert('error')
      },
      timeout: function () {
        alert('time out')
      }
    })
  }

  function getMarket() {
    myGeo.getPoint(adds, function (point) {
      if (point) {
        house_location = new BMap.Point(point.lng, point.lat);
//          markers.push(new BMap.Marker(address));
      }
    }, "北京市");
  }

  function starter() {

    setTimeout(function () {
      getData();
      setTimeout(function () {
        getMarket();
        setTimeout(function () {
          setTimeout(function () {
            searchLocal(bus_info, '公交站', 'home/bus');
            setTimeout(function () {
              searchLocal(shopping_info, '商场', 'home/shopping');
              setTimeout(function () {
                searchLocal(supermarket_info, '超市', 'home/supermarket');
                setTimeout(function () {
                  searchLocal(subway_info, '地铁', 'home/subway');
                  setTimeout(function () {
                    searchLocal(school_info, '学校', 'home/school');
                    setTimeout(function () {
                      searchLocal(hospital_info, '医院', 'home/hospital');
                      setTimeout(function () {
                        searchLocal(hospital_info, '写字楼', 'home/work');
                        setTimeout(function () {

                          adds = null;
                          house_location = null;
                          bus_info = [];
                          subway_info = [];
                          hospital_info = [];
                          school_info = [];
                          shopping_info = [];
                          supermarket_info = [];
                          work_info = [];
                          starter();
                        }, 1000)
                      }, 1000)
                    }, 1000)
                  }, 1000)
                }, 1000)
              }, 1000)
            }, 1000)
          }, 1000)
        }, 1000);
      }, 1000);
    }, 1000);
  }

  function searchLocal(array, keyword, url) {
    map.centerAndZoom(house_location, 15);
    map.clearOverlays();
    var circle = new BMap.Circle(house_location, 2000, {
      fillColor: "blue",
      strokeWeight: 1,
      fillOpacity: 0.1,
      strokeOpacity: 0.3
    });
    map.addOverlay(circle);
    var local = new BMap.LocalSearch(map, {
      renderOptions: {map: map, autoViewport: false},
      pageCapacity: 5,
      onSearchComplete: function (results) {
        if (local.getStatus() == BMAP_STATUS_SUCCESS) {
          for (var i = 0; i < results.getCurrentNumPois(); i++) {
            var locate = results.getPoi(i);
            var distance = map.getDistance(locate.point, house_location);
            var polyline = new BMap.Polyline([locate.point, house_location], {
              strokeColor: "blue",
              strokeWeight: 4,
              strokeOpacity: 0.5
            });
            map.addOverlay(polyline);
            if (locate.tags) {
              array.push("{" + locate.title + ',' + locate.tags + "/" + locate.point.lng + '/' + locate.point.lat + '/' + distance + '}');
            } else {
              array.push("{" + locate.title + "/" + locate.point.lng + '/' + locate.point.lat + '/' + distance + '}');
            }
          }
          document.getElementById("r-result").innerHTML = array.join("<br/>");
          submit(array, url);
        }
      }
    });
    local.searchNearby(keyword, house_location, 2000);
  }

  function submit(info, url) {
    $.ajax({
      type: "POST",
      url: url, //sumbits it to the given url of the form
      data: "info=" + info,
      dataType: "JSON"
    }).success(function (json) {
      console.log("success", json);
    });
  }

</script>


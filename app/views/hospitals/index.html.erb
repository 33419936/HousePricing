<br>
<div class="container-fluid">
  <div class="row">

    <div class="col-sm-3">
      <div class="well">
        <div class="row">
          <button class="btn btn-success btn-sm" onclick="starter(); " style="margin-left: 10px">开始</button>
        </div>
      </div>
      <div id="r-result"></div>
    </div>

    <div class="col-sm-9">
      <div id="l-map" style="height: 500px;width: 100%">
      </div>
    </div>

  </div>
</div>

<script type="text/javascript">

  var map = new BMap.Map("l-map");
  map.centerAndZoom(new BMap.Point(116.404, 39.915), 12);
  map.enableScrollWheelZoom(true);
  var myGeo = new BMap.Geocoder();
  var keyword = '医院';
  var url = 'hospitals';

  function getData() {
    $.ajax({
      type: "GET",
      url: "hospitals/ajax",
      dataType: 'json',
      success: function (data) {
        var id = data.id;
        myGeo.getPoint(data.community, function (point) {
          if (point) {
            var house_location = new BMap.Point(point.lng, point.lat);
            searchLocal(id, house_location, keyword, url);
          }
        }, "北京市");
      },
      error: function () {
        alert('error')
      },
      timeout: function () {
        alert('time out')
      }
    });
  }

  function starter() {
    setTimeout(function () {
      getData();
      setTimeout(function () {
        starter();
      }, 500);
    }, 500);
  }

  function searchLocal(id, location, keyword, url) {
    var array = [];
    map.clearOverlays();
    var local = new BMap.LocalSearch(map, {
      renderOptions: {map: map, autoViewport: true},
      onSearchComplete: function (results) {
        if (local.getStatus() == BMAP_STATUS_SUCCESS) {
          for (var i = 0; i < results.getCurrentNumPois(); i++) {
            var locate = results.getPoi(i);
            if (locate != null) {
              var distance = map.getDistance(locate.point, location);
              array.push(locate.title + "/" + locate.point.lng + '/' + locate.point.lat + '/' + distance);
            }
          }
          document.getElementById("r-result").innerHTML = array.join("<br/>");

          $.ajax({
            type: "POST",
            url: url,
            data: "info=" + array + "&id=" + id,
            dataType: "JSON",
            success: function (data) {
              console.log("success", data);
            },
            error: function () {
              alert('error in post');
            },
            timeout: function () {
              alert('time out in post')
            }
          });
        }
      }
    });
    local.searchNearby(keyword, location, 2000);
  }

</script>

